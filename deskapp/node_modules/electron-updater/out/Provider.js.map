{"version":3,"file":"Provider.js","sourceRoot":"","sources":["../src/Provider.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,AAAO,AAAmC,AAAiB,AAAiD,AAAM,AAAsB;;;;;;AAExI,AAAO,AAAE,AAAQ,AAAE,AAAM,AAAS;;;;;;AAElC,AAAO,AAAE,AAAc,AAA0B,AAAM,AAAQ,AAE/D,AAAM;;;;;AAGJ,gBAA+B,AAA2B,UAAW,0BAA0B,AAAI;AAApE,aAAQ,WAAR,AAAQ,AAAmB;AAAW,aAAuB,0BAAvB,AAAuB,AAAO,AACnG;AAAC;AAED,QAAI,AAAwB;AAC1B,AAAM,eAAC,AAAI,AACb;AAAC;AAED,AAAiB,sBAAC,AAAiC;AACjD,AAAI,aAAC,AAAc,iBAAG,AAAK,AAC7B;AAAC;AAMD,AAAW,gBAAC,AAAQ,KAAE,AAAoC,SAAE,AAAqC;AAC/F,AAAM,eAAC,AAAI,KAAC,AAAQ,SAAC,AAAO,QAAC,AAAI,KAAC,AAAoB,qBAAC,AAAG,KAAE,AAAO,AAAC,UAAE,AAAiB,AAAC,AAC1F;AAAC;AAES,AAAoB,yBAAC,AAAQ,KAAE,AAAoC;AAC3E,cAAM,AAAM,SAAmB,AAAE;AACjC,AAAE,AAAC,YAAC,AAAI,KAAC,AAAc,kBAAI,AAAI,AAAC,MAAC,AAAC;AAChC,AAAE,AAAC,gBAAC,AAAO,WAAI,AAAI,AAAC,MAAC,AAAC;AACpB,AAAM,uBAAC,AAAO,UAAG,AAAO,AAC1B;AAAC,AACH;AAAC,AACD,AAAI,eAAC,AAAC;AACJ,AAAM,mBAAC,AAAO,UAAG,AAAO,WAAI,AAAI,AAAC,AAAC,OAAC,AAAI,KAAC,AAAc,AAAC,AAAC,mCAAK,AAAI,KAAC,AAAc,gBAAK,AAAO,AAAC,AAC/F;AAAC;AAED,AAAM,eAAC,AAAQ,WAAG,AAAG,IAAC,AAAQ;AAC9B,AAAM,eAAC,AAAQ,WAAG,AAAG,IAAC,AAAQ;AAC9B,AAAE,AAAC,YAAC,AAAG,IAAC,AAAI,AAAC,MAAC,AAAC;AACb,AAAM,mBAAC,AAAI,OAAG,AAAG,IAAC,AAAI,AACxB;AAAC;AACD,AAAM,eAAC,AAAI,OAAG,AAAG,IAAC,AAAQ,WAAG,AAAG,IAAC,AAAM;AACvC,AAAM,eAAC,AAAM,AACf;AAAC,AACF,AAED,AAAM;;;kBAAmB,AAAoC,OAAE,AAAiB,WAAE,AAAmB;AACnG,AAAE,AAAC,QAAC,AAAK,MAAC,AAAM,WAAK,AAAC,AAAC,GAAC,AAAC;AACvB,cAAM,IAAI,AAAK,MAAC,AAAmB,AAAC,AACtC;AAAC;AAED,UAAM,AAAM,SAAG,AAAK,MAAC,AAAI,KAAC,AAAE,AAAC,AAAE,MAAC,AAAE,GAAC,AAAG,IAAC,AAAQ,SAAC,AAAW,AAAE,cAAC,AAAQ,AAAC,aAAI,AAAS,SAAE,AAAC,AAAC;AACxF,AAAE,AAAC,QAAC,AAAM,UAAI,AAAI,AAAC,MAAC,AAAC;AACnB,AAAM,eAAC,AAAM,AACf;AAAC,AACD,AAAI,eAAK,AAAG,OAAI,AAAI,AAAC,MAAC,AAAC;AACrB,AAAM,eAAC,AAAK,MAAC,AAAC,AAAC,AACjB;AAAC,AACD,AAAI,KAHC,AAAE,AAAC,MAGH,AAAC;AACJ,AAAM,eAAC,AAAK,MAAC,AAAI,KAAC,AAAQ,AAAC,AAAE,YAAC,CAAC,AAAG,IAAC,AAAI,KAAC,AAAG,AAAC,AAAE,OAAC,AAAQ,SAAC,AAAG,IAAC,AAAQ,SAAC,AAAW,AAAE,cAAC,AAAQ,AAAC,aAAI,AAAG,GAAE,AAAC,AAAC,AAAC,AAC1G;AAAC,AACH;AAAC,AAED,AAAM;yBAA0B,AAAsB,SAAE,AAAmB,aAAE,AAAmB;AAC9F,AAAE,AAAC,QAAC,AAAO,WAAI,AAAI,AAAC,MAAC,AAAC;AACpB,cAAM,IAAI,AAAK,AAAC,uCAAiC,AAAW,gDAAqC,AAAc,cAAkB,AAAC,AACpI;AAAC;AAED,QAAI,AAAkB;AACtB,QAAI,AAAC;AACH,AAAM,iBAAG,AAAQ,0CAAC,AAAO,AAAC,AAC5B;AAAC,MACD,AAAK,AAAC,OAAC,AAAC,AAAC,GAAC,AAAC;AACT,cAAM,IAAI,AAAK,AAAC,uCAAiC,AAAW,gDAAqC,AAAc,oBAAM,AAAC,EAAC,AAAK,SAAI,AAAC,EAAC,AAAO,qBAAc,AAAO,OAAE,AAAC,AACnK;AAAC;AACD,AAAM,WAAC,AAAM,AACf;AAAC,AAED,AAAM;qBAAsB,AAAsB;AAChD,UAAM,AAAK,QAAG,AAAU,WAAC,AAAK;AAC9B,AAAE,AAAC,QAAC,AAAK,SAAI,AAAI,QAAI,AAAK,MAAC,AAAM,SAAG,AAAC,AAAC,GAAC,AAAC;AACtC,AAAM,eAAC,AAAK,AACd;AAAC;AAED,AAAE,AAAC,QAAC,AAAU,WAAC,AAAI,QAAI,AAAI,AAAC,MAAC,AAAC;AAC5B,AAAM;AAEF,AAAG,iBAAE,AAAU,WAAC,AAAI;AACpB,AAAM,oBAAE,AAAU,WAAC,AAAM,AAC1B,AACF,AACH;AALI,SADK;AAMR,AACD,AAAI,WAAC,AAAC;AACJ,cAAM,IAAI,AAAK,AAAC,4BAAsB,AAAiB,2EAAC,AAAU,AAAC,WAAE,AAAC,AACxE;AAAC,AACH;AAAC,AAED,AAAM;sBAAuB,AAAsB,YAAE,AAAY,SAAE,kBAAyC,AAAC,AAAC,AAAE,KAAC,AAAC;AAChH,UAAM,AAAK,QAAG,AAAW,YAAC,AAAU,AAAC;AACrC,UAAM,AAAM,eAAwC,AAAG,IAAC,AAAQ,AAAC,AAAE;AACjE,AAAE,AAAC,YAAE,AAAgB,SAAC,AAAI,QAAI,AAAI,QAAI,AAAQ,SAAC,AAAM,UAAI,AAAI,AAAC,MAAC,AAAC;AAC9D,kBAAM,IAAI,AAAK,AAAC,yEAAmE,AAAiB,2EAAC,AAAQ,AAAC,SAAE,AAAC,AACnH;AAAC;AACD,AAAM;AACJ,AAAG,iBAAE,AAAc,4CAAC,AAAe,gBAAC,AAAQ,SAAC,AAAG,AAAC,MAAE,AAAO,AAAC;AAC3D,AAAI,kBAAE,AAAQ,AACf,AACH;AAJS;AAIR,AAAC,KAR4C,AAAK;AAUnD,UAAM,AAAQ,WAAI,AAAgC,WAAC,AAAQ;AAC3D,UAAM,AAAW,cAAG,AAAQ,YAAI,AAAI,AAAC,AAAC,OAAC,AAAI,AAAC,AAAC,AAAC,OAAC,AAAQ,SAAC,AAAO,QAAC,AAAI,AAAC,SAAI,AAAQ,SAAC,AAAI,AAAC;AACvF,AAAE,AAAC,QAAC,AAAW,eAAI,AAAI,AAAC,MAAC,AAAC;AACvB,AAAM,eAAC,AAAC,AAAS,GAAC,AAAW,gCACzB,AAAW,eACd,AAAI,MAAE,AAAc,4CAAC,AAAe,gBAAC,AAAW,YAAC,AAAI,AAAC,OAAE,AAAO,AAAC,SAAC,AAAI,AACtE,AACH;AAAC;AACD,AAAM,WAAC,AAAM,AACf;AAAC","sourcesContent":["import { CancellationToken, HttpExecutor, safeStringifyJson, UpdateFileInfo, UpdateInfo, WindowsUpdateInfo } from \"builder-util-runtime\"\nimport { OutgoingHttpHeaders, RequestOptions } from \"http\"\nimport { safeLoad } from \"js-yaml\"\nimport { URL } from \"url\"\nimport { newUrlFromBase, ResolvedUpdateFileInfo } from \"./main\"\n\nexport abstract class Provider<T extends UpdateInfo> {\n  protected requestHeaders: OutgoingHttpHeaders | null\n\n  constructor(protected readonly executor: HttpExecutor<any>, readonly useMultipleRangeRequest = true) {\n  }\n\n  get fileExtraDownloadHeaders(): OutgoingHttpHeaders | null {\n    return null\n  }\n\n  setRequestHeaders(value: OutgoingHttpHeaders | null): void {\n    this.requestHeaders = value\n  }\n\n  abstract getLatestVersion(): Promise<T>\n\n  abstract resolveFiles(updateInfo: UpdateInfo): Array<ResolvedUpdateFileInfo>\n\n  httpRequest(url: URL, headers?: OutgoingHttpHeaders | null, cancellationToken?: CancellationToken) {\n    return this.executor.request(this.createRequestOptions(url, headers), cancellationToken)\n  }\n\n  protected createRequestOptions(url: URL, headers?: OutgoingHttpHeaders | null): RequestOptions {\n    const result: RequestOptions = {}\n    if (this.requestHeaders == null) {\n      if (headers != null) {\n        result.headers = headers\n      }\n    }\n    else {\n      result.headers = headers == null ? this.requestHeaders : {...this.requestHeaders, ...headers}\n    }\n\n    result.protocol = url.protocol\n    result.hostname = url.hostname\n    if (url.port) {\n      result.port = url.port\n    }\n    result.path = url.pathname + url.search\n    return result\n  }\n}\n\nexport function findFile(files: Array<ResolvedUpdateFileInfo>, extension: string, not?: Array<string>): ResolvedUpdateFileInfo | null | undefined  {\n  if (files.length === 0) {\n    throw new Error(\"No files provided\")\n  }\n\n  const result = files.find(it => it.url.pathname.toLowerCase().endsWith(`.${extension}`))\n  if (result != null) {\n    return result\n  }\n  else if (not == null) {\n    return files[0]\n  }\n  else {\n    return files.find(fileInfo => !not.some(ext => fileInfo.url.pathname.toLowerCase().endsWith(`.${ext}`)))\n  }\n}\n\nexport function parseUpdateInfo(rawData: string | null, channelFile: string, channelFileUrl: URL): UpdateInfo {\n  if (rawData == null) {\n    throw new Error(`Cannot parse update info from ${channelFile} in the latest release artifacts (${channelFileUrl}): rawData: null`)\n  }\n\n  let result: UpdateInfo\n  try {\n    result = safeLoad(rawData)\n  }\n  catch (e) {\n    throw new Error(`Cannot parse update info from ${channelFile} in the latest release artifacts (${channelFileUrl}): ${e.stack || e.message}, rawData: ${rawData}`)\n  }\n  return result\n}\n\nexport function getFileList(updateInfo: UpdateInfo): Array<UpdateFileInfo> {\n  const files = updateInfo.files\n  if (files != null && files.length > 0) {\n    return files\n  }\n\n  if (updateInfo.path != null) {\n    return [\n      {\n        url: updateInfo.path,\n        sha512: updateInfo.sha512,\n      },\n    ]\n  }\n  else {\n    throw new Error(`No files provided: ${safeStringifyJson(updateInfo)}`)\n  }\n}\n\nexport function resolveFiles(updateInfo: UpdateInfo, baseUrl: URL, pathTransformer: (p: string) => string = p => p): Array<ResolvedUpdateFileInfo> {\n  const files = getFileList(updateInfo)\n  const result: Array<ResolvedUpdateFileInfo> = files.map(fileInfo => {\n    if ((fileInfo as any).sha2 == null && fileInfo.sha512 == null) {\n      throw new Error(`Update info doesn't contain nor sha256 neither sha512 checksum: ${safeStringifyJson(fileInfo)}`)\n    }\n    return {\n      url: newUrlFromBase(pathTransformer(fileInfo.url), baseUrl),\n      info: fileInfo,\n    }\n  })\n\n  const packages = (updateInfo as WindowsUpdateInfo).packages\n  const packageInfo = packages == null ? null : (packages[process.arch] || packages.ia32)\n  if (packageInfo != null) {\n    (result[0] as any).packageInfo = {\n      ...packageInfo,\n      path: newUrlFromBase(pathTransformer(packageInfo.path), baseUrl).href,\n    }\n  }\n  return result\n}"]}
