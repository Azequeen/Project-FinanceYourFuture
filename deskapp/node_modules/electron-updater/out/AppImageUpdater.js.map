{"version":3,"file":"AppImageUpdater.js","sourceRoot":"","sources":["../src/AppImageUpdater.ts"],"names":[],"mappings":"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","sourcesContent":["import BluebirdPromise from \"bluebird-lst\"\nimport { AllPublishOptions, CancellationToken, DownloadOptions, UpdateInfo } from \"builder-util-runtime\"\nimport { readBlockMapDataFromAppImage } from \"builder-util-runtime/out/blockMapApi\"\nimport { execFileSync, spawn } from \"child_process\"\nimport isDev from \"electron-is-dev\"\nimport { chmod, unlinkSync } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport \"source-map-support/register\"\nimport { BaseUpdater } from \"./BaseUpdater\"\nimport { AppImageDifferentialDownloader } from \"./differentialDownloader/AppImageDifferentialDownloader\"\nimport { UPDATE_DOWNLOADED, UpdateCheckResult } from \"./main\"\nimport { findFile } from \"./Provider\"\n\nexport class AppImageUpdater extends BaseUpdater {\n  constructor(options?: AllPublishOptions | null, app?: any) {\n    super(options, app)\n  }\n\n  checkForUpdatesAndNotify(): Promise<UpdateCheckResult | null> {\n    if (isDev) {\n      return BluebirdPromise.resolve(null)\n    }\n\n    if (process.env.APPIMAGE == null) {\n      this._logger.warn(\"APPIMAGE env is not defined, current application is not an AppImage\")\n      return BluebirdPromise.resolve(null)\n    }\n\n    return super.checkForUpdatesAndNotify()\n  }\n\n  /*** @private */\n  protected async doDownloadUpdate(updateInfo: UpdateInfo, cancellationToken: CancellationToken): Promise<Array<string>> {\n    const provider = await this.provider\n    const fileInfo = findFile(provider.resolveFiles(updateInfo), \"AppImage\")!!\n\n    const requestHeaders = await this.computeRequestHeaders()\n    const downloadOptions: DownloadOptions = {\n      skipDirCreation: true,\n      headers: requestHeaders,\n      cancellationToken,\n      sha512: fileInfo.info.sha512,\n    }\n\n    let installerPath = this.downloadedUpdateHelper.getDownloadedFile(updateInfo, fileInfo)\n    if (installerPath != null) {\n      return [installerPath]\n    }\n\n    await this.executeDownload(downloadOptions, fileInfo, async (tempDir, destinationFile) => {\n      installerPath = destinationFile\n\n      const oldFile = process.env.APPIMAGE!!\n      if (oldFile == null) {\n        throw new Error(\"APPIMAGE env is not defined\")\n      }\n\n      let isDownloadFull = false\n      try {\n        await new AppImageDifferentialDownloader(fileInfo.info, this.httpExecutor, {\n          newUrl: fileInfo.url.href,\n          oldFile,\n          logger: this._logger,\n          newFile: installerPath,\n          useMultipleRangeRequest: provider.useMultipleRangeRequest,\n          requestHeaders,\n        })\n          .download(JSON.parse(await readBlockMapDataFromAppImage(oldFile)))\n      }\n      catch (e) {\n        this._logger.error(`Cannot download differentially, fallback to full download: ${e.stack || e}`)\n        // during test (developer machine mac) we must throw error\n        isDownloadFull = process.platform === \"linux\"\n      }\n\n      if (isDownloadFull) {\n        await this.httpExecutor.download(fileInfo.url.href, installerPath, downloadOptions)\n      }\n\n      await chmod(installerPath, 0o755)\n    })\n\n    this.downloadedUpdateHelper.setDownloadedFile(installerPath!!, null, updateInfo, fileInfo)\n    this.addQuitHandler()\n    this.emit(UPDATE_DOWNLOADED, this.updateInfo)\n    return [installerPath!!]\n  }\n\n  protected doInstall(installerPath: string, isSilent: boolean, isRunAfter: boolean): boolean {\n    const appImageFile = process.env.APPIMAGE!!\n    if (appImageFile == null) {\n      throw new Error(\"APPIMAGE env is not defined\")\n    }\n\n    // https://stackoverflow.com/a/1712051/1910191\n    unlinkSync(appImageFile)\n\n    let destination: string\n    if (path.basename(installerPath) === path.basename(appImageFile)) {\n      // no version in the file name, overwrite existing\n      destination = appImageFile\n    }\n    else {\n      destination = path.join(path.dirname(appImageFile), path.basename(installerPath))\n    }\n\n    execFileSync(\"mv\", [\"-f\", installerPath, destination])\n\n    const env: any = {\n      ...process.env,\n      APPIMAGE_SILENT_INSTALL: \"true\",\n    }\n\n    if (isRunAfter) {\n      spawn(destination, [], {\n        detached: true,\n        stdio: \"ignore\",\n        env,\n      })\n        .unref()\n    }\n    else {\n      env.APPIMAGE_EXIT_AFTER_INSTALL = \"true\"\n      execFileSync(destination, [], {env})\n    }\n    return true\n  }\n}"]}
