{"version":3,"file":"GenericProvider.js","sourceRoot":"","sources":["../src/GenericProvider.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,AAAO,AAAwB,AAAS,AAAc,AAAM,AAAsB;;;;;;AAElF,AAAO,AAAE,AAAkB,AAAE,AAAoB,AAAE,AAAqB,AAAE,AAAmB,AAAE,AAAU,AAAE,AAAc,AAAE,AAAQ,AAA0B,AAAM,AAAQ;;;;;;AAC3K,AAAO,AAAE,AAAe,AAAE,AAAY,AAAE,AAAM,AAAY,AAE1D,AAAM;;;;MAAuB,AAAQ,AAAoB;AAGvD,gBAA6B,AAAmC,eAAmB,AAAmB,SAAE,AAAuB,0BAAG,AAAI;AACpI,AAAK,cAAC,AAAO,QAAC,AAAY,cAAE,AAAuB,AAAC;AADzB,aAAa,gBAAb,AAAa,AAAsB;AAAmB,aAAO,UAAP,AAAO,AAAY;AAFrF,aAAO,UAAG,AAAU,wCAAC,AAAI,KAAC,AAAa,cAAC,AAAG,AAAC,AAI7D;AAAC;AAED,QAAY,AAAO;AACjB,cAAM,AAAM,SAAG,AAAI,KAAC,AAAO,QAAC,AAAO,WAAI,AAAI,KAAC,AAAa,cAAC,AAAO;AACjE,AAAM,eAAC,AAAM,UAAI,AAAI,AAAC,AAAC,OAAC,AAAqB,AAAE,AAAC,AAAC,uDAAC,AAAoB,kDAAC,AAAM,AAAC,AAChF;AAAC;AAEK,AAAgB,oBAAtB,AAAK;;;;AACH,gBAAI,AAAkB;AACtB,kBAAM,AAAW,cAAG,AAAkB,gDAAC,AAAI,MAAC,AAAO,AAAC;AACpD,kBAAM,AAAU,aAAG,AAAc,4CAAC,AAAW,aAAE,AAAI,MAAC,AAAO,AAAC;AAC5D,AAAG,AAAC,iBAAC,IAAI,AAAa,gBAAG,AAAC,IAAI,AAAa,AAAE,iBAAE,AAAC;AAC9C,oBAAI,AAAC;AACH,AAAM,6BAAG,AAAe,sDAAC,MAAM,AAAI,MAAC,AAAW,YAAC,AAAU,AAAC,cAAE,AAAW,aAAE,AAAU,AAAC;AACrF,AAAK,AACP;AAAC,kBACD,AAAK,AAAC,OAAC,AAAC,AAAC,GAAC,AAAC;AACT,AAAE,AAAC,wBAAC,AAAC,AAAY,AAAS,8EAAI,AAAC,EAAC,AAAU,eAAK,AAAG,AAAC,KAAC,AAAC;AACnD,8BAAM,IAAI,AAAK,AAAC,8BAAwB,AAAW,6BAAkB,AAAC,EAAC,AAAK,SAAI,AAAC,EAAC,AAAO,OAAE,AAAC,AAC9F;AAAC,AACD,AAAI,2BAAC,AAAE,AAAC,IAAC,AAAC,EAAC,AAAI,SAAK,AAAc,AAAC,gBAAC,AAAC;AACnC,AAAE,AAAC,4BAAC,AAAa,gBAAG,AAAC,AAAC,GAAC,AAAC;AACtB,sCAAU,AAAO,QAAC,UAAC,AAAO,SAAE,AAAM,AAAE,AAAE;AACpC,oCAAI,AAAC;AACH,AAAU,+CAAC,AAAO,SAAE,AAAI,OAAG,AAAa,AAAC,AAC3C;AAAC,kCACD,AAAK,AAAC,OAAC,AAAC,AAAC,GAAC,AAAC;AACT,AAAM,2CAAC,AAAC,AAAC,AACX;AAAC,AACH;AAAC,AAAC,6BAPI;AAQN,AAAQ,AACV;AAAC,AACH;AAAC;AACD,0BAAM,AAAC,AACT;AAAC,AACH;AAAC;AAED,AAAE,AAAC,gBAAC,AAAmB,AAAE,AAAC,oDAAC,AAAC;AACzB,AAAc,uBAAC,AAAc,iBAAG,AAAU,WAAC,AAAI,AAClD;AAAC;AACD,AAAM,mBAAC,AAAM,AACf;;AAAC;AAED,AAAY,iBAAC,AAAsB;AACjC,AAAM,eAAC,AAAY,kDAAC,AAAU,YAAE,AAAI,KAAC,AAAO,AAAC,AAC/C;AAAC,AACF","sourcesContent":["import { GenericServerOptions, HttpError, UpdateInfo } from \"builder-util-runtime\"\nimport { AppUpdater } from \"./AppUpdater\"\nimport { getChannelFilename, getCustomChannelName, getDefaultChannelName, isUseOldMacProvider, newBaseUrl, newUrlFromBase, Provider, ResolvedUpdateFileInfo } from \"./main\"\nimport { parseUpdateInfo, resolveFiles } from \"./Provider\"\n\nexport class GenericProvider extends Provider<UpdateInfo> {\n  private readonly baseUrl = newBaseUrl(this.configuration.url)\n\n  constructor(private readonly configuration: GenericServerOptions, private readonly updater: AppUpdater, useMultipleRangeRequest = true) {\n    super(updater.httpExecutor, useMultipleRangeRequest)\n  }\n\n  private get channel(): string {\n    const result = this.updater.channel || this.configuration.channel\n    return result == null ? getDefaultChannelName() : getCustomChannelName(result)\n  }\n\n  async getLatestVersion(): Promise<UpdateInfo> {\n    let result: UpdateInfo\n    const channelFile = getChannelFilename(this.channel)\n    const channelUrl = newUrlFromBase(channelFile, this.baseUrl)\n    for (let attemptNumber = 0; ; attemptNumber++) {\n      try {\n        result = parseUpdateInfo(await this.httpRequest(channelUrl), channelFile, channelUrl)\n        break\n      }\n      catch (e) {\n        if (e instanceof HttpError && e.statusCode === 404) {\n          throw new Error(`Cannot find channel \"${channelFile}\" update info: ${e.stack || e.message}`)\n        }\n        else if (e.code === \"ECONNREFUSED\") {\n          if (attemptNumber < 3) {\n            await new Promise((resolve, reject) => {\n              try {\n                setTimeout(resolve, 1000 * attemptNumber)\n              }\n              catch (e) {\n                reject(e)\n              }\n            })\n            continue\n          }\n        }\n        throw e\n      }\n    }\n\n    if (isUseOldMacProvider()) {\n      (result as any).releaseJsonUrl = channelUrl.href\n    }\n    return result\n  }\n\n  resolveFiles(updateInfo: UpdateInfo): Array<ResolvedUpdateFileInfo> {\n    return resolveFiles(updateInfo, this.baseUrl)\n  }\n}"]}
