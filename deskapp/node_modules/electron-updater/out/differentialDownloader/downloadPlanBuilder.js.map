{"version":3,"file":"downloadPlanBuilder.js","sourceRoot":"","sources":["../../src/differentialDownloader/downloadPlanBuilder.ts"],"names":[],"mappings":"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","sourcesContent":["import { BlockMap, BlockMapFile } from \"builder-util-runtime/out/blockMapApi\"\nimport { Logger } from \"../main\"\n\nexport enum OperationKind {\n  COPY, DOWNLOAD\n}\n\nexport interface Operation {\n  kind: OperationKind\n\n  start: number\n  end: number\n}\n\nexport function computeOperations(oldBlockMap: BlockMap, newBlockMap: BlockMap, logger: Logger) {\n  const nameToOldBlocks = buildBlockFileMap(oldBlockMap.files)\n  const nameToNewBlocks = buildBlockFileMap(newBlockMap.files)\n\n  const oldEntryMap = buildEntryMap(oldBlockMap.files)\n\n  let lastOperation: Operation | null = null\n\n  const operations: Array<Operation> = []\n  for (const blockMapFile of newBlockMap.files) {\n    const name = blockMapFile.name\n    const oldEntry = oldEntryMap.get(name)\n    if (oldEntry == null) {\n      // new file\n      operations.push({\n        kind: OperationKind.DOWNLOAD,\n        start: blockMapFile.offset,\n        end: blockMapFile.offset + blockMapFile.sizes.reduce((accumulator, currentValue) => accumulator + currentValue),\n      })\n      continue\n    }\n\n    const newFile = nameToNewBlocks.get(name)!!\n    let changedBlockCount = 0\n\n    const {checksumToOffset: checksumToOldOffset, checksumToOldSize} = buildChecksumMap(nameToOldBlocks.get(name)!!, oldEntry.offset)\n\n    let newOffset = blockMapFile.offset\n    for (let i = 0; i < newFile.checksums.length; newOffset += newFile.sizes[i], i++) {\n      const blockSize = newFile.sizes[i]\n      const checksum = newFile.checksums[i]\n      let oldOffset: number | null | undefined = checksumToOldOffset.get(checksum)\n      if (oldOffset != null && checksumToOldSize.get(checksum) !== blockSize) {\n        logger.warn(`Checksum (\"${checksum}\") matches, but size differs (old: ${checksumToOldSize.get(checksum)}, new: ${blockSize})`)\n        oldOffset = null\n      }\n\n      if (oldOffset == null) {\n        changedBlockCount++\n\n        if (lastOperation == null || lastOperation.kind !== OperationKind.DOWNLOAD || lastOperation.end !== newOffset) {\n          lastOperation = {\n            kind: OperationKind.DOWNLOAD,\n            start: newOffset,\n            end: newOffset + blockSize,\n          }\n          operations.push(lastOperation)\n        }\n        else {\n          lastOperation.end += blockSize\n        }\n      }\n      else if (lastOperation == null || lastOperation.kind !== OperationKind.COPY || lastOperation.end !== oldOffset) {\n        lastOperation = {\n          kind: OperationKind.COPY,\n          start: oldOffset,\n          end: oldOffset + blockSize,\n        }\n        operations.push(lastOperation)\n      }\n      else {\n        lastOperation.end += blockSize\n      }\n    }\n\n    if (changedBlockCount > 0) {\n      logger.info(`File${blockMapFile.name === \"file\" ? \"\" : (\" \" + blockMapFile.name)} has ${changedBlockCount} changed blocks`)\n    }\n  }\n  return operations\n}\n\nfunction buildChecksumMap(file: BlockMapFile, fileOffset: number) {\n  const checksumToOffset = new Map<string, number>()\n  const checksumToSize = new Map<string, number>()\n  let offset = fileOffset\n  for (let i = 0; i < file.checksums.length; i++) {\n    const checksum = file.checksums[i]\n    const size = file.sizes[i]\n    checksumToOffset.set(checksum, offset)\n    checksumToSize.set(checksum, size)\n    offset += size\n  }\n  return {checksumToOffset, checksumToOldSize: checksumToSize}\n}\n\nfunction buildEntryMap(list: Array<BlockMapFile>) {\n  const result = new Map<string, BlockMapFile>()\n  for (const item of list) {\n    result.set(item.name, item)\n  }\n  return result\n}\n\nfunction buildBlockFileMap(list: Array<BlockMapFile>) {\n  const result = new Map<string, BlockMapFile>()\n  for (const item of list) {\n    result.set(item.name, item)\n  }\n  return result\n}"]}
